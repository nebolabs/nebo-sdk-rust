syntax = "proto3";

package apps.v0;

option go_package = "github.com/neboloop/nebo/internal/apps/pb";

import "proto/apps/v0/common.proto";

// ChannelService is the interface for messaging channel apps (Discord, Telegram, etc.).
service ChannelService {
  // HealthCheck verifies the channel app is running.
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);

  // ID returns the channel's unique identifier.
  rpc ID(Empty) returns (IDResponse);

  // Connect establishes the channel connection.
  rpc Connect(ChannelConnectRequest) returns (ChannelConnectResponse);

  // Disconnect closes the channel connection.
  rpc Disconnect(Empty) returns (ChannelDisconnectResponse);

  // Send sends a message to a channel.
  rpc Send(ChannelSendRequest) returns (ChannelSendResponse);

  // Receive streams inbound messages from the channel to Nebo.
  rpc Receive(Empty) returns (stream InboundMessage);

  // Configure updates the app's settings.
  rpc Configure(SettingsMap) returns (Empty);
}

message IDResponse {
  string id = 1;
}

message ChannelConnectRequest {
  map<string, string> config = 1;
}

message ChannelConnectResponse {
  string error = 1;
}

message ChannelDisconnectResponse {
  string error = 1;
}

message ChannelSendRequest {
  string channel_id = 1;
  string text = 2;
  // v1 envelope fields (optional â€” apps can use just channel_id + text)
  string message_id = 3;       // UUID v7, set by Nebo if empty
  MessageSender sender = 4;    // agent identity
  repeated Attachment attachments = 5;
  string reply_to = 6;         // message_id for threading
  repeated MessageAction actions = 7;  // buttons, keyboards
  bytes platform_data = 8;     // opaque passthrough
}

message ChannelSendResponse {
  string error = 1;
  string message_id = 2;       // echoed or platform-assigned ID
}

message InboundMessage {
  string channel_id = 1;
  string user_id = 2;
  string text = 3;
  string metadata = 4; // JSON-encoded metadata (legacy)
  // v1 envelope fields
  string message_id = 5;
  MessageSender sender = 6;
  repeated Attachment attachments = 7;
  string reply_to = 8;
  repeated MessageAction actions = 9;
  bytes platform_data = 10;
  string timestamp = 11;       // RFC3339
}

// MessageSender identifies who sent a message.
message MessageSender {
  string name = 1;
  string role = 2;      // relationship dynamic (Friend, COO, Mentor)
  string bot_id = 3;    // NeboLoop bot UUID
}

// Attachment represents a file or media attachment.
message Attachment {
  string type = 1;       // "image", "file", "audio", "video"
  string url = 2;
  string filename = 3;
  int64 size = 4;        // bytes
}

// MessageAction represents an interactive element (button, keyboard row).
message MessageAction {
  string label = 1;
  string callback_id = 2;
}
